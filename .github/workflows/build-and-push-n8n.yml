name: Build and Push Custom n8n Image

on:
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight
  workflow_dispatch: # Allows manual triggering of the workflow

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ secrets.GITHUB_ACTOR }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for upstream image update
        id: check-upstream
        run: |
          UPSTREAM_IMAGE="docker.n8n.io/n8nio/n8n:latest"
          LOCAL_IMAGE="ghcr.io/${{ github.repository_owner }}/custom-n8n:latest"
          UPSTREAM_DIGEST=$(docker manifest inspect $UPSTREAM_IMAGE --format '{{ .Descriptor.Digest }}')
          LOCAL_DIGEST=$(docker manifest inspect $LOCAL_IMAGE --format '{{ .Descriptor.Digest }}' || echo "not found")
          echo "UPSTREAM_DIGEST=$UPSTREAM_DIGEST" >> $GITHUB_ENV
          echo "LOCAL_DIGEST=$LOCAL_DIGEST" >> $GITHUB_ENV

      - name: Build and push custom n8n image
        if: env.UPSTREAM_DIGEST != env.LOCAL_DIGEST
        run: |
          docker build -t ghcr.io/${{ github.repository_owner }}/custom-n8n:latest -f apps/n8n/dockerfile .
          docker push ghcr.io/${{ github.repository_owner }}/custom-n8n:latest